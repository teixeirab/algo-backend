-- ISIN --
select
series_number as 'Series Number',
account_id as 'Account Number',
security_description as 'Sedol/Cusip/Internal',
opening_position as 'Opening Position',
purchases as 'Transactions - Purchases',
sales as 'Transactions - Sales',
closing_position as 'Closing Position',
market_price_at_quarter_end as 'Market price at quarter-end',
yield as 'Yield',
maturity_date as 'Maturity date',
original_maturity as 'Original maturity'

from (
-- PERSHING --
select
distinct(substring(t1.description, locate('ISIN', t1.description) + 5, 14)) security_description,
t0.series_number,
account account_id,
coalesce(t2_bq.market_value, 0) opening_position,
sum(case when t1.net_amount < 0 and settlement_date > (select pershing_start_date from quarterly_reporting_setup where id = 0) then abs(t1.net_amount) else 0 end) purchases,
sum(case when t1.net_amount > 0 and settlement_date > (select pershing_start_date from quarterly_reporting_setup where id = 0) then abs(t1.net_amount) else 0 end) sales,
coalesce(t2_eq.market_value, 0) closing_position,
coalesce(t2_eq.price, 0) market_price_at_quarter_end,
coalesce(t2_eq.current_yield, t2_bq.current_yield) yield,
coalesce(t2_eq.maturity_date, t2_bq.maturity_date) maturity_date,
'Over two years' original_maturity
from series_product_information t0
join pershing_trades t1 on (locate(t1.account, t0.account_number) > 0)
left outer join pershing_positions t2_bq on (t1.account = t2_bq.account_number and t1.cusip = t2_bq.cusip and t2_bq.period in ((select pershing_start_date from quarterly_reporting_setup where id = 0)))
left outer join pershing_positions t2_eq on (t1.account = t2_eq.account_number and t1.cusip = t2_eq.cusip and t2_eq.period in ((select pershing_end_date from quarterly_reporting_setup where id = 0)))
where 1=1
and (t2_bq.asset_classification = 'FIXED INCOME' or t2_eq.asset_classification='FIXED INCOME')
and locate('ISIN', t1.description)  > 0
and (t2_bq.market_value is not null or t2_eq.market_value is not null)
group by security_description, t0.series_number, account_id, opening_position, closing_position, market_price_at_quarter_end, yield, maturity_date, original_maturity

UNION
-- CITIBANK --
select
t1.isin security_description,
t0.series_number,
t1.account_id account_id,
coalesce(t2_bq.market_value, 0) opening_position,
sum(case when t1.transaction_type in ('RVP', 'RF')
			and t1.settlement_date >= (select citibank_start_date from quarterly_reporting_setup where id = 0)
            and t1.settlement_date <= (select citibank_end_date from quarterly_reporting_setup where id = 0)
		 then abs(t1.setltement_amount) else 0 end) purchases,
sum(case when t1.transaction_type in ('DVP', 'DF')
	        and t1.settlement_date >= (select citibank_start_date from quarterly_reporting_setup where id = 0)
            and t1.settlement_date <= (select citibank_end_date from quarterly_reporting_setup where id = 0)
		 then abs(t1.setltement_amount) else 0 end)  sales,
coalesce(t2_eq.market_value, 0) closing_position,
coalesce(t2_eq.market_value, 0)  market_price_at_quarter_end,
coalesce(t2_eq.interest_rate, t2_bq.interest_rate, 0)  yield,
coalesce(t2_eq.maturity_date, t2_bq.maturity_date) maturity_date,
'Over two years' original_maturity
from
series_names t01
join series_product_information t0 on (t01.series_number = t0.series_number)
join citi_all_transactions t1 on (locate(t1.account_id, t0.account_number) > 0)
left outer join (select f.*, v.market_value from citi_fixed_income_settled_position f, citi_positions_valuations v where f.account_id = v.account_id and f.isin= v.isin and f.as_of_date = v.as_of_date)
	t2_bq on (t1.account_id = t2_bq.account_id and t1.isin = t2_bq.isin and t2_bq.as_of_date in ((select citibank_start_date from quarterly_reporting_setup where id = 0)))
left outer join (select f.*, v.market_value from citi_fixed_income_settled_position f, citi_positions_valuations v where f.account_id = v.account_id and f.isin= v.isin and f.as_of_date = v.as_of_date)
	t2_eq on (t1.account_id = t2_eq.account_id and t1.isin = t2_eq.isin and t2_eq.as_of_date in ((select citibank_end_date from quarterly_reporting_setup where id = 0)))
where 1=1
and t1.account_id not in ('6017709722')
and t1.isin in (select distinct(isin) from citi_fixed_income_settled_position)
and (t2_bq.market_value is not null or t2_eq.market_value is not null)
group by security_description, series_number, account_id, opening_position, closing_position, market_price_at_quarter_end, yield, maturity_date, original_maturity
order by series_number asc, closing_position desc
) a