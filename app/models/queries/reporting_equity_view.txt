select
custody_account_provider as 'Custody Account Provider',
series_number as 'Series Number',
account_id as 'Account ID',
opening_position as 'Opening Position',
purchases as 'Transactions - Purchases',
sales as 'Transactions - Sales',
closing_position as 'Closing Position'

from (

-- Interactive Brokers --
select
'Interactive Brokers' custody_account_provider,
coalesce(t2_eq.account_id, t2_bq.account_id) account_id,
t0.series_number,
coalesce(t2_eq.currency, t2_bq.currency) currency,
sum(t2_bq.market_value) opening_position,
sum(case when t1.gross_amount < 0 and settle_date > ((select ib_start_date from quarterly_reporting_setup where id = 0)) and settle_date < ((select ib_end_date from quarterly_reporting_setup where id = 0))
		then abs(t1.gross_amount) else 0 end) purchases,
sum(case when t1.gross_amount > 0 and settle_date > ((select ib_start_date from quarterly_reporting_setup where id = 0)) and settle_date < ((select ib_end_date from quarterly_reporting_setup where id = 0))
		then abs(t1.gross_amount) else 0 end) sales,
sum(t2_eq.market_value) closing_position
from (select series_number, account_number from series_product_information) t0
join (select * from ib_positions where report_date in ((select ib_start_date from quarterly_reporting_setup where id = 0))) t2_bq on (locate(t2_bq.account_id, t0.account_number) > 0)
left outer join (select * from ib_positions where report_date in ((select ib_end_date from quarterly_reporting_setup where id = 0))) t2_eq on (t2_bq.account_id = t2_eq.account_id and t2_bq.security_id = t2_eq.security_id)
left outer join ib_activity t1 on (t1.account_id = t2_eq.account_id and t1.security_id = t2_eq.security_id)
and t1.asset_type='STK'
group by custody_account_provider, account_id, t0.series_number, currency

Union

-- Citibank --
select
'Citibank' custody_account_provider,
t1.account_id account_id,
t0.series_number,
t1.currency currency,
sum(coalesce(t2_bq.market_value, 0)) opening_position,
sum(case when t1.transaction_type in ('RVP', 'RF')
			and t1.settlement_date >= (select citibank_start_date from quarterly_reporting_setup where id = 0)
            and t1.settlement_date <= (select citibank_end_date from quarterly_reporting_setup where id = 0)
		 then abs(t1.setltement_amount) else 0 end) purchases,
sum(case when t1.transaction_type in ('DVP', 'DF')
	        and t1.settlement_date >= (select citibank_start_date from quarterly_reporting_setup where id = 0)
            and t1.settlement_date <= (select citibank_end_date from quarterly_reporting_setup where id = 0)
		 then abs(t1.setltement_amount) else 0 end)  sales,
sum(coalesce(t2_eq.market_value, 0)) closing_position
from series_names t01
join series_product_information t0 on (t01.series_number = t0.series_number)
join citi_all_transactions t1 on (locate(t1.account_id, t0.account_number) > 0 and t1.isin not in (select distinct(isin) from citi_fixed_income_settled_position))
left outer join (select v.* from citi_positions_valuations v where v.isin not in (select distinct(isin) from citi_fixed_income_settled_position))
	t2_bq on (t1.account_id = t2_bq.account_id and t1.isin = t2_bq.isin and t2_bq.as_of_date in ((select citibank_start_date from quarterly_reporting_setup where id = 0)))
left outer join (select v.* from citi_positions_valuations v where v.isin not in (select isin from citi_fixed_income_settled_position))
	t2_eq on (t1.account_id = t2_eq.account_id and t1.isin = t2_eq.isin and t2_eq.as_of_date in ((select citibank_end_date from quarterly_reporting_setup where id = 0)))
where 1=1
and t1.account_id not in ('6017709722')
group by custody_account_provider, account_id, series_number,t1.currency

Union
-- Pershing --
select
'Pershing' custody_account_provider,
account account_id,
t0.series_number,
'USD' currency,
sum(t2_bq.market_value) opening_position,
sum(case when t1.net_amount < 0 and settlement_date >= (select pershing_start_date from quarterly_reporting_setup where id = 0) and settlement_date <= (select pershing_end_date from quarterly_reporting_setup where id = 0) then abs(t1.net_amount) else 0 end) purchases,
sum(case when t1.net_amount > 0 and settlement_date >= (select pershing_start_date from quarterly_reporting_setup where id = 0) and settlement_date <= (select pershing_end_date from quarterly_reporting_setup where id = 0) then abs(t1.net_amount) else 0 end) sales,
sum(t2_eq.market_value) closing_position
from series_product_information t0
join (select * from pershing_trades where locate('BUY', description) > 0 or locate('SELL', description) > 0) t1 on (locate(t1.account, t0.account_number) > 0)
left outer join pershing_positions t2_bq on (t1.account = t2_bq.account_number and t1.cusip = t2_bq.cusip and t2_bq.period in ((select pershing_start_date from quarterly_reporting_setup where id = 0)))
left outer join pershing_positions t2_eq on (t1.account = t2_eq.account_number and t1.cusip = t2_eq.cusip and t2_eq.period in ((select pershing_end_date from quarterly_reporting_setup where id = 0)))
where t0.account_number = t1.account
and (t2_bq.asset_classification in ('EQUITY', 'MUTUAL FUND') or t2_eq.asset_classification in ('EQUITY', 'MUTUAL FUND'))
group by custody_account_provider, account_id, series_number, currency

) a