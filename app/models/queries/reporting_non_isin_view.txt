-- NON ISIN --
select
account_id as 'Series Number',
security_description as 'Sedol/Cusip/Internal',
opening_position as 'Opening Position',
purchases as 'Transactions - Purchases',
sales as 'Transactions - Sales',
closing_position as 'Closing Position',
market_price_at_quarter_end as 'Market price at quarter-end',
yield as 'Yield',
maturity_date as 'Maturity date',
original_maturity as 'Original maturity',
country as 'Country',
sector as 'Sector'

from (

-- INTERACTIVE BROKERS --
select
distinct(substring(replace(replace(replace(t1.security_description, " ", ""), "/" ,""), ".", ""), 1, 15)) security_description,
concat(t0.series_number, '-', t1.account_id) account_id,
t2_bq.market_value opening_position,
sum(case when t1.gross_amount < 0 then abs(t1.gross_amount) else 0 end) purchases,
sum(case when t1.gross_amount > 0 then abs(t1.gross_amount) else 0 end) sales,
t2_eq.market_value closing_position,
t2_eq.market_price market_price_at_quarter_end,
0 yield,
0 maturity_date,
0 original_maturity,
0 country,
0 sector
from series_product_information t0
join ib_activity t1 on ((locate(t1.account_id, t0.account_number) > 0))
left outer join ib_positions t2_bq on (t1.account_id = t2_bq.account_id and t1.security_id = t2_bq.security_id and t2_bq.report_date in ((select ib_start_date from quarterly_reporting_setup where id = 0)))
left outer join ib_positions t2_eq on (t1.account_id = t2_eq.account_id and t1.security_id = t2_eq.security_id and t2_eq.report_date in ((select ib_end_date from quarterly_reporting_setup where id = 0)))
where 1=1
and t1.asset_type='BOND'
and settle_date > ((select ib_start_date from quarterly_reporting_setup where id = 0))
group by security_description,  account_id, opening_position, closing_position, market_price_at_quarter_end, yield, maturity_date, original_maturity, country, sector

Union
-- PERSHING --
select
distinct(t1.cusip) security_description,
account account_id,
t2_bq.market_value opening_position,
sum(case when t1.net_amount < 0 then abs(t1.net_amount) else 0 end) purchases,
sum(case when t1.net_amount > 0 then abs(t1.net_amount) else 0 end) sales,
t2_eq.market_value closing_position,
t2_eq.price market_price_at_quarter_end,
0 yield,
0 maturity_date,
0 original_maturity,
0 country,
0 sector
from series_product_information t0
join pershing_trades t1 on ((locate(t1.account, t0.account_number) > 0))
left outer join pershing_positions t2_bq on (t1.account = t2_bq.account_number and t1.security_id = t2_bq.security_id and t2_bq.period in ((select pershing_start_date from quarterly_reporting_setup where id = 0)))
left outer join pershing_positions t2_eq on (t1.account = t2_eq.account_number and t1.security_id = t2_eq.security_id and t2_eq.period in ((select pershing_end_date from quarterly_reporting_setup where id = 0)))
where 1=1
and (t2_bq.asset_classification='FIXED INCOME' or t2_eq.asset_classification='FIXED INCOME')
and settlement_date > ((select pershing_start_date from quarterly_reporting_setup where id = 0))
and locate('ISIN', t1.description)  <= 0
group by security_description, account_id, opening_position, closing_position, market_price_at_quarter_end, yield, maturity_date, original_maturity, country, sector
order by closing_position
) a
